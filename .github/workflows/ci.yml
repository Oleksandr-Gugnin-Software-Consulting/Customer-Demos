name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Required permissions for private repository
permissions:
  contents: read
  pull-requests: read
  checks: write
  statuses: write

jobs:
  changes:
    name: Detect changed files
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      core: ${{ steps.filter.outputs.core }}
      tests: ${{ steps.filter.outputs.tests }}
      docs: ${{ steps.filter.outputs.docs }}
      docker: ${{ steps.filter.outputs.docker }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git diff

      - name: Check for file changes
        id: filter
        run: |
          # Determine base ref for comparison
          # - For pull requests use the base commit SHA
          # - For pushes use the previous commit SHA from the webhook (`github.event.before`)
          #   which points to the commit before the push. Fall back to `origin/main` if unavailable.
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="${{ github.event.before }}"
            if [ -z "$BASE_REF" ] || [ "$BASE_REF" = "0000000000000000000000000000000000000000" ]; then
              BASE_REF="origin/main"
            fi
          fi

          echo "Comparing against: $BASE_REF"

          # Fetch the base ref so that `git diff` can compare against it.
          # Try fetching the specific base SHA first, otherwise fetch all refs.
          git fetch origin "$BASE_REF":refs/remotes/origin/base || git fetch --all --prune || true

          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_REF...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check each category
          CORE_CHANGED="false"
          TESTS_CHANGED="false"
          DOCS_CHANGED="false"
          DOCKER_CHANGED="false"
          CI_CHANGED="false"

          while IFS= read -r file; do
            case "$file" in
              core/*|requirements.txt|pyproject.toml)
                CORE_CHANGED="true"
                ;;
              tests/*|conftest.py)
                TESTS_CHANGED="true"
                ;;
              docs/*|*.md|LICENSE)
                DOCS_CHANGED="true"
                ;;
              Dockerfile|docker-compose*.yml|.dockerignore)
                DOCKER_CHANGED="true"
                ;;
              .github/workflows/*)
                CI_CHANGED="true"
                ;;
            esac
          done <<< "$CHANGED_FILES"

          # Set outputs
          echo "core=$CORE_CHANGED" >> $GITHUB_OUTPUT
          echo "tests=$TESTS_CHANGED" >> $GITHUB_OUTPUT
          echo "docs=$DOCS_CHANGED" >> $GITHUB_OUTPUT
          echo "docker=$DOCKER_CHANGED" >> $GITHUB_OUTPUT
          echo "ci=$CI_CHANGED" >> $GITHUB_OUTPUT

          # Summary
          echo "### File Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "- Core: $CORE_CHANGED" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: $TESTS_CHANGED" >> $GITHUB_STEP_SUMMARY
          echo "- Docs: $DOCS_CHANGED" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: $DOCKER_CHANGED" >> $GITHUB_STEP_SUMMARY
          echo "- CI: $CI_CHANGED" >> $GITHUB_STEP_SUMMARY

  test:
    uses: ./.github/workflows/reusable-test.yml
    name: Unit tests on Python matrix
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.tests == 'true' || needs.changes.outputs.ci == 'true'
    secrets: inherit

  integration-test:
    uses: ./.github/workflows/reusable-integration.yml
    name: Integration tests
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.tests == 'true' || needs.changes.outputs.ci == 'true'
    secrets: inherit

  lint:
    uses: ./.github/workflows/reusable-lint.yml
    name: Lint and format checks
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.tests == 'true' || needs.changes.outputs.ci == 'true'
    permissions:
      contents: read
      checks: write
    secrets: inherit

  type-check:
    uses: ./.github/workflows/reusable-typecheck.yml
    name: Type checking with mypy
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.tests == 'true' || needs.changes.outputs.ci == 'true'
    permissions:
      contents: read
      checks: write
    secrets: inherit

  security:
    uses: ./.github/workflows/reusable-security.yml
    name: Security checks
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.tests == 'true' || needs.changes.outputs.ci == 'true'
    permissions:
      contents: read
      checks: write
    secrets: inherit

  performance-test:
    uses: ./.github/workflows/reusable-performance.yml
    name: Performance benchmarks
    needs: [changes, test, integration-test, lint, type-check, security]
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.tests == 'true' || needs.changes.outputs.ci == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    secrets: inherit
  docker-build:
    uses: ./.github/workflows/reusable-docker-build.yml
    name: Docker image build
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.docker == 'true' || needs.changes.outputs.ci == 'true'
    with:
      context: .
      dockerfile: ./Dockerfile
      tag: real-estate-api:test
    permissions:
      contents: read
      checks: write
    secrets: inherit

  self_hosted_demo:
    name: Self-hosted runner demo
    # This job intentionally runs on any available self-hosted runner to demonstrate
    # that self-hosted runners accept jobs. It is unconditional (runs on every push).
    # Temporarily disabled for demo (avoid claiming self-hosted availability)
    if: false
    runs-on: [self-hosted]
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show runner environment (demo)
      run: |
        echo "--- Runner / Environment Demo ---"
        echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
        echo "GITHUB_RUN_NUMBER=$GITHUB_RUN_NUMBER"
        echo "RUNNER_NAME=$RUNNER_NAME"
        echo "RUNNER_OS=$RUNNER_OS"
        echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
        echo "--- uname ---"
        uname -a || true
        echo "--- env (partial) ---"
        env | sort | sed -n '1,200p'
        echo "--- docker status (if available) ---"
        docker --version || true
        docker ps -a || true
